<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melingua Connect</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #111827; /* bg-gray-900 */
            color: #f9fafb;
            overflow: hidden;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        .listening-glow {
            box-shadow: 0 0 15px 4px rgba(239, 68, 68, 0.6);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 15px 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: #1f2937;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-body { flex-grow: 1; display: flex; }
        .modal-close-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }

        /* Map Styles - REMOVED the aggressive filter */
        #map { height: 100%; width: 100%; background: #111827; }
        .leaflet-control-attribution { display: none; }

        .keyword-button {
            color: #93c5fd; text-decoration: underline; text-underline-offset: 3px;
            cursor: pointer; background: none; border: none; padding: 0; font: inherit;
        }
        .keyword-button:hover { color: #60a5fa; text-decoration-thickness: 2px; }
        
        .recommendations-panel {
            background-color: #2c2c2c; border-left: 3px solid #60a5fa;
            padding: 0.75rem 1rem; margin-left: 1rem; margin-bottom: 1rem;
            border-radius: 0 8px 8px 0; animation: fadeIn 0.4s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    {% raw %}
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Sidebar = ({ conversations, activeConversationId, onNewChat, onSelectChat, onDeleteChat }) => (
            <aside className="w-72 bg-[#181818] p-4 flex-col hidden md:flex border-r border-white/10">
                <button onClick={onNewChat} className="w-full bg-white/90 text-black font-semibold rounded-lg flex items-center justify-center gap-2 py-2.5 mb-6 hover:bg-white/70 transition-colors">
                    <i className="bi bi-plus-lg"></i> New Chat
                </button>
                <div className="flex-1 overflow-y-auto custom-scrollbar pr-2">
                    <h2 className="text-xs text-gray-400 font-semibold mb-2 px-2 tracking-wider">CONVERSATIONS</h2>
                    <ul>
                        {conversations.map((convo, index) => (
                            <li key={convo.id} className={`flex items-center justify-between group fade-in rounded-md ${activeConversationId === convo.id ? 'bg-white/10' : 'hover:bg-white/5'}`} style={{ animationDelay: `${index * 50}ms` }}>
                                <a href="#" onClick={(e) => { e.preventDefault(); onSelectChat(convo.id); }} className={`block text-sm p-2.5 truncate transition-colors duration-200 flex-1 ${activeConversationId === convo.id ? 'text-white font-semibold' : 'text-gray-300'}`}>
                                    {convo.messages.find(m => m.type === 'user')?.text || 'New Conversation'}
                                </a>
                                <button onClick={(e) => {e.stopPropagation(); onDeleteChat(convo.id)}} className="p-2 text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i className="bi bi-trash3-fill"></i>
                                </button>
                            </li>
                        ))}
                    </ul>
                </div>
            </aside>
        );
        
        const LanguageSelector = ({ languages, selectedLang, onSelectLang, label }) => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);
            const selectedLangName = languages.find(l => l.code === selectedLang)?.name || "Select";
            useEffect(() => {
                const handleClickOutside = (event) => { if (dropdownRef.current && !dropdownRef.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            return <div className="relative" ref={dropdownRef}><button onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-2 text-sm text-gray-300 hover:text-white transition-colors">{label}: <span className="font-semibold text-white">{selectedLangName}</span> <i className={`bi bi-chevron-down transition-transform ${isOpen ? 'rotate-180' : ''}`}></i></button>{isOpen && <div className="absolute top-full mt-2 right-0 w-56 bg-gray-800 border border-white/10 rounded-lg shadow-2xl z-10 flex flex-col fade-in"><div className="max-h-60 overflow-y-auto custom-scrollbar">{languages.map(lang => <button key={lang.code} onClick={() => { onSelectLang(lang.code); setIsOpen(false); }} className="w-full text-left text-sm px-4 py-2 hover:bg-indigo-600 transition-colors">{lang.name}</button>)}</div></div>}</div>;
        };

        const Header = ({ sourceLang, targetLang, setSourceLang, setTargetLang, languages, onSwap, onSosClick, isLocating }) => (
            <header className="p-4 flex items-center justify-between border-b border-white/10">
                <h1 className="text-xl font-bold">MediLingua Connect</h1>
                <div className="flex items-center gap-4">
                    <LanguageSelector languages={languages} selectedLang={sourceLang} onSelectLang={setSourceLang} label="From" />
                    <button onClick={onSwap} className="p-2 rounded-full hover:bg-white/10 transition-colors"><i className="bi bi-arrow-left-right text-gray-300"></i></button>
                    <LanguageSelector languages={languages} selectedLang={targetLang} onSelectLang={setTargetLang} label="To" />
                    <button onClick={onSosClick} disabled={isLocating} title="Find Nearby Hospitals" className="ml-4 px-4 py-2 bg-red-600 text-white font-bold rounded-lg flex items-center gap-2 hover:bg-red-700 disabled:bg-red-800 disabled:cursor-wait transition-all transform hover:scale-105">
                        {isLocating ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <i className="bi bi-hospital"></i>}
                        <span>{isLocating ? 'Locating...' : 'SOS'}</span>
                    </button>
                </div>
            </header>
        );
        
        const MessageBubble = ({ message, onSpeak, isSpeaking, onToggleRecommendations, onKeywordClick }) => {
            const isUser = message.type === 'user';
            const renderMessageWithKeywords = () => {
                if (isUser || !message.keywords || message.keywords.length === 0) return <p className="whitespace-pre-wrap leading-relaxed">{message.text}</p>;
                const keywordMap = new Map();
                message.keywords.forEach(kw => keywordMap.set(kw.term.toLowerCase(), { english: kw.english, visual_aid_search: kw.visual_aid_search }));
                const sortedTerms = message.keywords.map(kw => kw.term).sort((a, b) => b.length - a.length);
                const escapedTerms = sortedTerms.map(term => term.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"));
                const regex = new RegExp(`(${escapedTerms.join("|")})`, "gi");
                const parts = message.text.split(regex);
                return <p className="whitespace-pre-wrap leading-relaxed">{parts.map((part, index) => { const keywordData = keywordMap.get(part.toLowerCase()); if (keywordData) { return <button key={index} className="keyword-button" onClick={(e) => onKeywordClick(keywordData, e)}>{part}</button>; } return <span key={index}>{part}</span>; })}</p>;
            };
            return <div className={`w-full flex ${isUser ? 'justify-end' : 'justify-start'}`}><div className={`max-w-2xl p-4 rounded-2xl mb-4 relative fade-in ${isUser ? 'bg-indigo-600' : 'bg-gray-700'} ${isSpeaking ? 'ring-2 ring-sky-400' : ''}`}>{renderMessageWithKeywords()}<div className="absolute -bottom-3 -right-1 flex items-center gap-1">{!isUser && <button onClick={() => onSpeak(message.text)} className="w-8 h-8 bg-gray-600 hover:bg-sky-600 rounded-full flex items-center justify-center transition-all transform hover:scale-110"><i className={`bi ${isSpeaking ? 'bi-stop-circle-fill text-sky-300' : 'bi-volume-up-fill'}`}></i></button>}{!isUser && message.recommendations && message.recommendations.length > 0 && <button onClick={() => onToggleRecommendations(message.id)} title="Show Analysis" className="w-8 h-8 bg-gray-600 hover:bg-indigo-600 rounded-full flex items-center justify-center transition-all transform hover:scale-110"><i className="bi bi-info-circle-fill text-indigo-300"></i></button>}</div></div></div>;
        };

        const RecommendationsPanel = ({ recommendations }) => (
            <div className="recommendations-panel">
                <p className="text-xs text-gray-400 mb-2">Disclaimer: This is not a substitute for professional medical advice. Always consult with a qualified health provider for a diagnosis and treatment plan.</p>
                <h4 className="font-semibold text-indigo-300 mb-2">Recommended Departments:</h4>
                <ul className="list-disc pl-5 text-gray-300">
                    {recommendations.map((rec, index) => (
                        <li key={index}>{rec.keyword} - {rec.department}</li>
                    ))}
                </ul>
            </div>
        );
        const ThinkingIndicator = () => <div className="w-full flex justify-start"><div className="max-w-2xl p-4 rounded-2xl mb-4 bg-gray-700 flex items-center gap-2"><div className="w-2.5 h-2.5 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div><div className="w-2.5 h-2.5 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div><div className="w-2.5 h-2.5 bg-gray-400 rounded-full animate-pulse"></div></div></div>;

        const ChatArea = ({ messages, isLoading, onSpeak, speakingText, onToggleRecommendations, visibleRecommendations, onKeywordClick }) => {
            const scrollRef = useRef(null);
            useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isLoading]);
            return <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">{messages.map(msg => <div key={msg.id}><MessageBubble message={msg} onSpeak={onSpeak} isSpeaking={speakingText === msg.text} onToggleRecommendations={onToggleRecommendations} onKeywordClick={onKeywordClick} />{visibleRecommendations[msg.id] && msg.recommendations && msg.recommendations.length > 0 && <RecommendationsPanel recommendations={msg.recommendations} />}</div>)}{isLoading && <ThinkingIndicator />}<div ref={scrollRef} /></div>;
        };

        const InputBar = ({ onTranslate, onFileTranslate, isLoading, isListening, onMicClick, text, setText }) => {
            const textareaRef = useRef(null);
            const fileInputRef = useRef(null);
            useEffect(() => { const el = textareaRef.current; if (el) { el.style.height = 'auto'; el.style.height = `${el.scrollHeight}px`; } }, [text]);
            const handleSubmit = (e) => { e.preventDefault(); if (text.trim() && !isLoading) onTranslate(text); };
            const handleFileChange = (e) => { const file = e.target.files[0]; if (file) onFileTranslate(file); };
            const handleKeyDown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmit(e); } };
            return <div className="p-4 bg-transparent"><div className="max-w-3xl mx-auto bg-gray-900/50 backdrop-blur-lg border border-white/10 rounded-2xl p-2 pl-4 shadow-2xl focus-within:border-indigo-500 transition-colors flex items-end gap-2"><input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".png,.jpg,.jpeg,.txt,.pdf,.doc,.docx,.csv" /><button onClick={() => fileInputRef.current.click()} type="button" title="Attach File" className="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-transparent rounded-full hover:bg-gray-500/30 text-gray-400 hover:text-white transition-all"><i className="bi bi-paperclip"></i></button><button onClick={onMicClick} type="button" className={`w-10 h-10 flex-shrink-0 flex items-center justify-center bg-transparent rounded-full hover:bg-red-500/30 transition-all ${isListening ? 'text-red-500 listening-glow' : 'text-gray-400'}`}><i className="bi bi-mic-fill"></i></button><form onSubmit={handleSubmit} className="flex-1 flex items-end"><textarea ref={textareaRef} value={text} onChange={(e) => setText(e.target.value)} onKeyDown={handleKeyDown} placeholder="Type, speak, or upload a file..." rows="1" className="w-full bg-transparent p-2 text-gray-100 placeholder-gray-400 focus:outline-none" style={{ maxHeight: '200px' }} /><button type="submit" disabled={isLoading || !text.trim()} className="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-gray-700 rounded-full hover:bg-indigo-600 disabled:bg-gray-800 transition-all"><i className="bi bi-arrow-up text-white"></i></button></form></div></div>;
        };
        
        const HospitalsModal = ({ isOpen, onClose, userLocation, hospitals, error }) => {
            const mapRef = useRef(null);
            const routeLayerRef = useRef(null);
            const [selectedHospital, setSelectedHospital] = useState(null);
            useEffect(() => {
                if (isOpen && !mapRef.current && userLocation) {
                    const map = L.map('map').setView([userLocation.lat, userLocation.lon], 13);
                    // UPDATED: Using CartoDB dark theme tiles
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                    }).addTo(map);
                    mapRef.current = map;
                    const userIcon = L.divIcon({ html: `<i class="bi bi-geo-alt-fill text-2xl text-sky-400"></i>`, className: '', iconSize: [24, 24], iconAnchor: [12, 24] });
                    L.marker([userLocation.lat, userLocation.lon], { icon: userIcon }).addTo(map).bindPopup("Your Location");
                    hospitals.forEach(h => {
                        const hospitalIcon = L.divIcon({ html: `<i class="bi bi-hospital-fill text-2xl text-red-500"></i>`, className: '', iconSize: [24, 24], iconAnchor: [12, 24] });
                        L.marker([h.lat, h.lon], { icon: hospitalIcon }).addTo(map).bindPopup(h.name);
                    });
                }
            }, [isOpen, userLocation, hospitals]);
            useEffect(() => {
                const map = mapRef.current;
                if (!map || !selectedHospital || !selectedHospital.geometry) return;
                if (routeLayerRef.current) map.removeLayer(routeLayerRef.current);
                const routeLine = L.geoJSON(selectedHospital.geometry, { style: { color: '#3498db', weight: 5 } }).addTo(map);
                routeLayerRef.current = routeLine;
                map.fitBounds(routeLine.getBounds().pad(0.1));
            }, [selectedHospital]);
            if (!isOpen) return null;
            const formatDistance = (m) => m < 0 ? "N/A" : m > 1000 ? `${(m / 1000).toFixed(1)} km` : `${Math.round(m)} m`;
            const formatDuration = (s) => s < 0 ? "N/A" : `${Math.round(s / 60)} min drive`;
            return <div className="modal-backdrop"><div className="modal-content" style={{width: '90vw', maxWidth: '1200px', height: '90vh', maxHeight: '800px'}}><div className="modal-header"><h2 className="text-xl font-semibold">Nearby Hospitals</h2><button onClick={onClose} className="modal-close-btn">&times;</button></div><div className="modal-body"><aside className="w-1/3 bg-gray-900 p-4 flex flex-col custom-scrollbar overflow-y-auto"><h3 className="text-lg font-bold mb-4 text-gray-200">Nearest Locations</h3>{error && <div className="text-red-400 p-3 bg-red-500/20 rounded-lg">{error}</div>}<ul>{hospitals.map(h => <li key={h.id} onClick={() => setSelectedHospital(h)} className={`p-3 rounded-lg cursor-pointer transition-colors mb-2 ${selectedHospital?.id === h.id ? 'bg-indigo-600' : 'bg-gray-700 hover:bg-gray-600'}`}><h4 className="font-semibold">{h.name}</h4><div className="text-sm text-gray-300 flex justify-between mt-1"><span>{formatDistance(h.distance)}</span><span>{formatDuration(h.duration)}</span></div></li>)}</ul></aside><main className="w-2/3 h-full">{userLocation && <div id="map"></div>}</main></div></div></div>;
        };
        
        const KeywordActionModal = ({ data, onClose, onSelectSign, onSelectVisualAid }) => {
            if (!data) return null;
            const { top, left, english, visual_aid_search } = data;
            return <div className="fixed inset-0 z-50" onClick={onClose}><div className="absolute bg-gray-700 border border-white/20 rounded-lg shadow-2xl p-2 flex flex-col gap-1 fade-in" style={{ top: `${top}px`, left: `${left}px`, transform: 'translate(-50%, 10px)' }} onClick={(e) => e.stopPropagation()}><button onClick={() => { onSelectSign(english); onClose(); }} className="w-full text-left text-sm px-3 py-1.5 rounded-md hover:bg-indigo-600 transition-colors flex items-center gap-2"><i className="bi bi-sign-language"></i> View Sign Language</button><button onClick={() => { onSelectVisualAid(visual_aid_search); onClose(); }} className="w-full text-left text-sm px-3 py-1.5 rounded-md hover:bg-green-600 transition-colors flex items-center gap-2"><i className="bi bi-image"></i> View Visual Aid</button></div></div>;
        };

        const SignLanguageModal = ({ videoUrl, onClose }) => {
            if (!videoUrl) return null;
            // UPDATED: Made modal larger
            return <div className="modal-backdrop" onClick={onClose}><div className="modal-content" style={{width: '90vw', maxWidth: '900px', height: '80vh'}} onClick={(e) => e.stopPropagation()}><div className="modal-header"><h2 className="text-lg font-semibold">Sign Language Video</h2><button onClick={onClose} className="modal-close-btn">&times;</button></div><div className="modal-body" style={{padding: '0'}}><iframe src={videoUrl} title="Sign Language Video" width="100%" height="100%" frameBorder="0" allowFullScreen></iframe></div></div></div>;
        };

        const App = () => {
            const initialConvo = { id: Date.now(), messages: [] };
            const [conversations, setConversations] = useState(() => JSON.parse(localStorage.getItem('conversations') || 'null') || [initialConvo]);
            const [activeConversationId, setActiveConversationId] = useState(() => JSON.parse(localStorage.getItem('activeConversationId') || 'null') || conversations[0]?.id || initialConvo.id);
            const [languages, setLanguages] = useState([]);
            const [sourceLang, setSourceLang] = useState('en');
            const [targetLang, setTargetLang] = useState('es');
            const [isLoading, setIsLoading] = useState(false);
            const [isLocating, setIsLocating] = useState(false);
            const [speakingText, setSpeakingText] = useState(null);
            const [isListening, setIsListening] = useState(false);
            const [text, setText] = useState("");
            const [signVideoUrl, setSignVideoUrl] = useState('');
            const [visibleRecommendations, setVisibleRecommendations] = useState({});
            const [actionModalData, setActionModalData] = useState(null);
            const [isSosModalOpen, setIsSosModalOpen] = useState(false);
            const [hospitalsData, setHospitalsData] = useState([]);
            const [userLocation, setUserLocation] = useState(null);
            const [sosError, setSosError] = useState(null);
            const recognitionRef = useRef(null);
            const API_BASE_URL = '';

            useEffect(() => { localStorage.setItem('conversations', JSON.stringify(conversations)); localStorage.setItem('activeConversationId', JSON.stringify(activeConversationId)); }, [conversations, activeConversationId]);
            useEffect(() => { const fetchLangs = async () => { try { const res = await fetch(`${API_BASE_URL}/api/languages`); const data = await res.json(); setLanguages(data); } catch (e) { console.error(e); }}; fetchLangs(); }, []);
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return;
                recognitionRef.current = new SpeechRecognition();
                const recognition = recognitionRef.current;
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.onresult = (event) => { let t = ''; for (let i = 0; i < event.results.length; i++) { t += event.results[i][0].transcript; } setText(t); };
                recognition.onend = () => setIsListening(false);
                return () => recognition.stop();
            }, []);

            const handleMicClick = () => { if (!recognitionRef.current) return; if (isListening) { recognitionRef.current.stop(); } else { setText(""); recognitionRef.current.lang = sourceLang; recognitionRef.current.start(); setIsListening(true); } };
            const handleSpeak = (txt) => { if (speakingText === txt) { window.speechSynthesis.cancel(); setSpeakingText(null); return; } const u = new SpeechSynthesisUtterance(txt); u.lang = targetLang; u.onstart = () => setSpeakingText(txt); u.onend = () => setSpeakingText(null); window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); };
            const handleNewChat = () => { const newConvo = { id: Date.now(), messages: [] }; setConversations(prev => [newConvo, ...prev]); setActiveConversationId(newConvo.id); };
            const handleDeleteChat = (id) => { const newConvos = conversations.filter(c => c.id !== id); setConversations(newConvos); if (activeConversationId === id) setActiveConversationId(newConvos[0]?.id || null); };
            const handleSwapLanguages = () => { setSourceLang(targetLang); setTargetLang(sourceLang); };
            const handleToggleRecommendations = (id) => setVisibleRecommendations(prev => ({ ...prev, [id]: !prev[id] }));
            const handleKeywordClick = (data, e) => { e.preventDefault(); setActionModalData({ ...data, top: e.clientY, left: e.clientX }); };
            const handleShowSignLanguage = (txt) => setSignVideoUrl(`https://www.spreadthesign.com/en.us/search/?q=${encodeURIComponent(txt.trim())}`);
            const handleShowVisualAid = (url) => window.open(url, '_blank');

            const handleTranslate = async (textToTranslate) => {
                const userMessage = { id: Date.now(), type: 'user', text: textToTranslate, keywords: [], recommendations: [] };
                setConversations(prev => prev.map(c => c.id === activeConversationId ? { ...c, messages: [...c.messages, userMessage] } : c));
                setText("");
                setIsLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/translate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: textToTranslate, source_lang: sourceLang, target_lang: targetLang }) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Translation failed');
                    const aiMessage = { id: Date.now() + 1, type: 'ai', text: data.translated_text, keywords: data.keywords || [], recommendations: data.recommendations || [] };
                    setConversations(prev => prev.map(c => c.id === activeConversationId ? { ...c, messages: [...c.messages, aiMessage] } : c));
                } catch (error) { console.error("Translation failed:", error); } 
                finally { setIsLoading(false); }
            };
            
            const handleFileTranslate = async (file) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('target_lang', targetLang);
                const userMessage = { id: Date.now(), type: 'user', text: `File: ${file.name}` };
                setConversations(prev => prev.map(c => c.id === activeConversationId ? { ...c, messages: [...c.messages, userMessage] } : c));
                setIsLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/translate-file`, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'File translation failed');
                    const aiMessage = { id: Date.now() + 1, type: 'ai', text: data.translated_text, keywords: data.keywords || [] };
                    setConversations(prev => prev.map(c => c.id === activeConversationId ? { ...c, messages: [...c.messages, aiMessage] } : c));
                } catch (error) { console.error("File translation failed:", error); }
                finally { setIsLoading(false); }
            };

            const handleSosClick = () => {
                if (!navigator.geolocation) { alert("Geolocation is not supported by your browser."); return; }
                setIsLocating(true);
                setSosError(null);
                setHospitalsData([]);
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    setUserLocation({ lat: latitude, lon: longitude });
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/nearby-hospitals-osm`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ lat: latitude, lon: longitude }) });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'Failed to fetch hospitals.');
                        setHospitalsData(data);
                    } catch (error) { setSosError(error.message); } 
                    finally { setIsLocating(false); setIsSosModalOpen(true); }
                }, (error) => {
                    setSosError("Could not get your location. Please enable location permissions.");
                    setIsLocating(false);
                    setIsSosModalOpen(true);
                });
            };

            const activeConversation = conversations.find(c => c.id === activeConversationId) || { messages: [] };

            return (
                <div className="flex h-screen w-full bg-[#212121]">
                    <Sidebar conversations={conversations} activeConversationId={activeConversationId} onNewChat={handleNewChat} onSelectChat={setActiveConversationId} onDeleteChat={handleDeleteChat} />
                    <main className="flex-1 flex flex-col">
                        <Header sourceLang={sourceLang} targetLang={targetLang} setSourceLang={setSourceLang} setTargetLang={setTargetLang} languages={languages} onSwap={handleSwapLanguages} onSosClick={handleSosClick} isLocating={isLocating} />
                        <ChatArea messages={activeConversation.messages} isLoading={isLoading} onSpeak={handleSpeak} speakingText={speakingText} onToggleRecommendations={handleToggleRecommendations} visibleRecommendations={visibleRecommendations} onKeywordClick={handleKeywordClick} />
                        <InputBar onTranslate={handleTranslate} onFileTranslate={handleFileTranslate} isLoading={isLoading} isListening={isListening} onMicClick={handleMicClick} text={text} setText={setText} />
                    </main>
                    <HospitalsModal isOpen={isSosModalOpen} onClose={() => setIsSosModalOpen(false)} userLocation={userLocation} hospitals={hospitalsData} error={sosError} />
                    <KeywordActionModal data={actionModalData} onClose={() => setActionModalData(null)} onSelectSign={handleShowSignLanguage} onSelectVisualAid={handleShowVisualAid} />
                    <SignLanguageModal videoUrl={signVideoUrl} onClose={() => setSignVideoUrl('')} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    {% endraw %}
</body>
</html>